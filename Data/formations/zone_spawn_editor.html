<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zone Spawn Editor - Blaze & Blade</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #e0e0e0; padding: 20px; }
h1 { color: #e94560; margin-bottom: 10px; }

.header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
#fileInput { background: #16213e; color: #e0e0e0; border: 1px solid #0f3460; padding: 8px 12px; border-radius: 4px; cursor: pointer; }

.info-panel { background: #16213e; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #e94560; }
.info-title { font-size: 1.3em; font-weight: 700; color: #e94560; }
.info-subtitle { color: #a0a0b0; margin-top: 4px; font-size: 0.95em; }
.info-stats { display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
.stat { display: flex; flex-direction: column; }
.stat-label { color: #808090; font-size: 0.85em; }
.stat-value { color: #53a8b6; font-weight: 700; font-size: 1.1em; margin-top: 2px; }

.budget { background: #16213e; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
.budget-label { font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.budget-numbers { font-size: 0.9em; color: #a0a0b0; }
.budget-bar { background: #0a0a1a; border-radius: 6px; height: 28px; position: relative; overflow: hidden; }
.budget-fill { height: 100%; transition: width 0.3s, background 0.3s; border-radius: 6px; }
.budget-fill.ok { background: linear-gradient(90deg, #0f3460, #53a8b6); }
.budget-fill.warn { background: linear-gradient(90deg, #e9a500, #ff8c00); }
.budget-fill.danger { background: linear-gradient(90deg, #e94560, #ff4060); }
.budget-text { position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.7); }

.toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
button { background: #0f3460; color: #e0e0e0; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: background 0.2s; }
button:hover { background: #1a508b; }
button.primary { background: #e94560; }
button.primary:hover { background: #ff5070; }
button.success { background: #10a010; }
button.success:hover { background: #12c012; }
button.danger { background: #c01040; }
button.danger:hover { background: #e01050; }
button:disabled { opacity: 0.4; cursor: not-allowed; }

.spawns { display: flex; flex-direction: column; gap: 12px; }
.spawn-group { background: #16213e; border-radius: 8px; padding: 16px; border: 2px solid transparent; transition: border-color 0.2s; }
.spawn-group.overflow { border-color: #ff4060; }

.spawn-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
.spawn-title { font-weight: 700; color: #53a8b6; font-size: 1.05em; }
.spawn-count { color: #a0a0b0; font-size: 0.9em; }
.spawn-composition { display: flex; gap: 6px; flex-wrap: wrap; }
.comp-pill { padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; color: #000; }
.spawn-actions { margin-left: auto; display: flex; gap: 6px; }

.records { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
.record { background: #0a0a1a; border-radius: 6px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.record-num { color: #606070; font-weight: 700; min-width: 30px; font-size: 0.9em; }
.record-monster { min-width: 140px; }
.record-monster select { background: #16213e; color: #e0e0e0; border: 1px solid #2a2a4e; padding: 6px 10px; border-radius: 4px; font-size: 0.9em; min-width: 140px; cursor: pointer; }
.record-coords { display: flex; gap: 6px; align-items: center; }
.coord-group { display: flex; align-items: center; gap: 4px; }
.coord-label { color: #808090; font-size: 0.85em; font-weight: 600; min-width: 14px; }
.coord-input { background: #16213e; color: #e0e0e0; border: 1px solid #2a2a4e; padding: 5px 8px; border-radius: 4px; width: 70px; font-size: 0.9em; text-align: right; }
.record-actions { margin-left: auto; display: flex; gap: 4px; }
.record-btn { padding: 4px 10px; font-size: 0.85em; }

.add-record-btn { width: 100%; margin-top: 8px; background: #0f3460; border: 2px dashed #2a2a4e; }
.add-record-btn:hover { background: #1a508b; border-color: #53a8b6; }

#status { margin-top: 16px; padding: 12px 16px; border-radius: 6px; display: none; font-weight: 600; }
#status.ok { display: block; background: #0f3460; color: #53a8b6; }
#status.err { display: block; background: #500020; color: #ff6b6b; }

.empty { color: #606070; font-style: italic; padding: 40px; text-align: center; font-size: 1.1em; }

.monster-colors { display: none; }
</style>
</head>
<body>

<h1>Zone Spawn Editor - Blaze & Blade</h1>

<div class="header">
  <label>
    <input type="file" id="fileInput" accept=".json">
  </label>
  <button onclick="saveFile()" class="success">üíæ Save JSON</button>
  <button onclick="addNewSpawnGroup()" class="primary">‚ûï Add Spawn Group</button>
</div>

<div id="infoPanel" class="info-panel" style="display:none;">
  <div class="info-title" id="areaName"></div>
  <div class="info-subtitle" id="levelName"></div>
  <div class="info-stats">
    <div class="stat">
      <span class="stat-label">Available Monsters</span>
      <span class="stat-value" id="monsterCount">0</span>
    </div>
    <div class="stat">
      <span class="stat-label">Spawn Groups</span>
      <span class="stat-value" id="spawnGroupCount">0</span>
    </div>
    <div class="stat">
      <span class="stat-label">Total Enemies</span>
      <span class="stat-value" id="totalEnemies">0</span>
    </div>
  </div>
</div>

<div id="budgetPanel" class="budget" style="display:none;">
  <div class="budget-label">
    <span>üíæ Space Budget</span>
    <span class="budget-numbers" id="budgetNumbers"></span>
  </div>
  <div class="budget-bar">
    <div class="budget-fill ok" id="budgetFill"></div>
    <div class="budget-text" id="budgetText">0%</div>
  </div>
</div>

<div class="toolbar" id="toolbar" style="display:none;">
  <button onclick="sortBySize()">‚ÜïÔ∏è Sort by Size</button>
  <button onclick="compactAllGroups()">üì¶ Compact All</button>
  <button onclick="calculateBudget()">üîÑ Refresh Budget</button>
</div>

<div id="spawnsContainer" class="spawns"></div>

<div id="status"></div>

<!-- Hidden color palette generator -->
<canvas id="colorCanvas" width="1" height="1" style="display:none;"></canvas>

<script>
const RECORD_SIZE = 32; // bytes per spawn record
let currentData = null;
let currentFile = null;

// Monster color palette
const monsterColors = {};

function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return hash;
}

function getMonsterColor(monster) {
  if (!monsterColors[monster]) {
    const hash = hashCode(monster);
    const hue = Math.abs(hash) % 360;
    const saturation = 65 + (Math.abs(hash >> 8) % 20);
    const lightness = 55 + (Math.abs(hash >> 16) % 15);
    monsterColors[monster] = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  }
  return monsterColors[monster];
}

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  currentFile = file.name;
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      currentData = JSON.parse(event.target.result);
      renderEditor();
      showStatus('File loaded: ' + file.name, 'ok');
    } catch (err) {
      showStatus('Error parsing JSON: ' + err.message, 'err');
    }
  };
  reader.readAsText(file);
});

function renderEditor() {
  if (!currentData) return;

  // Update info panel
  document.getElementById('areaName').textContent = currentData.name || 'Unknown Area';
  document.getElementById('levelName').textContent = currentData.level_name || 'Unknown Level';
  document.getElementById('monsterCount').textContent = (currentData.monsters || []).length;

  const spawnGroups = currentData.zone_spawns || [];
  document.getElementById('spawnGroupCount').textContent = spawnGroups.length;

  const totalEnemies = spawnGroups.reduce((sum, sg) => sum + (sg.total || 0), 0);
  document.getElementById('totalEnemies').textContent = totalEnemies;

  document.getElementById('infoPanel').style.display = 'block';
  document.getElementById('toolbar').style.display = 'flex';

  // Calculate and display budget
  calculateBudget();

  // Render spawn groups
  renderSpawnGroups();
}

function calculateBudget() {
  if (!currentData || !currentData.zone_spawns) return;

  const areaBytes = currentData.zone_spawns_area_bytes || 0;
  const spawns = currentData.zone_spawns || [];

  const totalRecords = spawns.reduce((sum, sg) => {
    return sum + (sg.records || []).length;
  }, 0);

  const usedBytes = totalRecords * RECORD_SIZE;
  const usagePercent = areaBytes > 0 ? (usedBytes / areaBytes) * 100 : 0;

  // Update budget display
  document.getElementById('budgetNumbers').textContent =
    `${usedBytes} / ${areaBytes} bytes (${totalRecords} records)`;

  const fill = document.getElementById('budgetFill');
  const text = document.getElementById('budgetText');

  fill.style.width = Math.min(100, usagePercent) + '%';
  text.textContent = usagePercent.toFixed(1) + '%';

  // Color coding
  fill.className = 'budget-fill ';
  if (usagePercent >= 100) fill.className += 'danger';
  else if (usagePercent >= 80) fill.className += 'warn';
  else fill.className += 'ok';

  document.getElementById('budgetPanel').style.display = 'block';

  return usagePercent;
}

function renderSpawnGroups() {
  const container = document.getElementById('spawnsContainer');
  container.innerHTML = '';

  const spawns = currentData.zone_spawns || [];

  if (spawns.length === 0) {
    container.innerHTML = '<div class="empty">No zone spawns. Click "Add Spawn Group" to create one.</div>';
    return;
  }

  spawns.forEach((spawn, idx) => {
    container.appendChild(createSpawnGroupCard(spawn, idx));
  });
}

function createSpawnGroupCard(spawn, idx) {
  const div = document.createElement('div');
  div.className = 'spawn-group';
  div.id = `spawn-${idx}`;

  // Check if this group would cause overflow
  const usagePercent = calculateBudget();
  if (usagePercent >= 100) {
    div.classList.add('overflow');
  }

  // Header
  const header = document.createElement('div');
  header.className = 'spawn-header';

  const title = document.createElement('div');
  title.className = 'spawn-title';
  title.textContent = `Group ${idx + 1}`;
  header.appendChild(title);

  const count = document.createElement('div');
  count.className = 'spawn-count';
  count.textContent = `${spawn.total || 0} enemies`;
  header.appendChild(count);

  // Composition pills
  const compDiv = document.createElement('div');
  compDiv.className = 'spawn-composition';
  (spawn.composition || []).forEach(comp => {
    const pill = document.createElement('div');
    pill.className = 'comp-pill';
    pill.style.background = getMonsterColor(comp.monster);
    pill.textContent = `${comp.monster} √ó${comp.count}`;
    compDiv.appendChild(pill);
  });
  header.appendChild(compDiv);

  // Actions
  const actions = document.createElement('div');
  actions.className = 'spawn-actions';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'danger record-btn';
  deleteBtn.textContent = 'üóëÔ∏è Delete Group';
  deleteBtn.onclick = () => deleteSpawnGroup(idx);
  actions.appendChild(deleteBtn);

  header.appendChild(actions);

  div.appendChild(header);

  // Records
  const recordsDiv = document.createElement('div');
  recordsDiv.className = 'records';

  (spawn.records || []).forEach((rec, recIdx) => {
    recordsDiv.appendChild(createRecordRow(rec, idx, recIdx));
  });

  div.appendChild(recordsDiv);

  // Add record button
  const addBtn = document.createElement('button');
  addBtn.className = 'add-record-btn';
  addBtn.textContent = '‚ûï Add Enemy to Group';
  addBtn.onclick = () => addRecordToGroup(idx);
  div.appendChild(addBtn);

  return div;
}

function createRecordRow(record, spawnIdx, recIdx) {
  const div = document.createElement('div');
  div.className = 'record';

  // Record number
  const num = document.createElement('div');
  num.className = 'record-num';
  num.textContent = `#${recIdx + 1}`;
  div.appendChild(num);

  // Monster selector
  const monsterDiv = document.createElement('div');
  monsterDiv.className = 'record-monster';

  const select = document.createElement('select');
  select.onchange = (e) => updateRecordMonster(spawnIdx, recIdx, parseInt(e.target.value));

  (currentData.monsters || []).forEach((monster, slotIdx) => {
    const option = document.createElement('option');
    option.value = slotIdx;
    option.textContent = monster;
    if (slotIdx === record.slot) option.selected = true;
    select.appendChild(option);
  });

  monsterDiv.appendChild(select);
  div.appendChild(monsterDiv);

  // Coordinates
  const coords = document.createElement('div');
  coords.className = 'record-coords';

  ['x', 'y', 'z'].forEach(axis => {
    const group = document.createElement('div');
    group.className = 'coord-group';

    const label = document.createElement('div');
    label.className = 'coord-label';
    label.textContent = axis.toUpperCase();
    group.appendChild(label);

    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'coord-input';
    input.value = record[axis] || 0;
    input.onchange = (e) => updateRecordCoord(spawnIdx, recIdx, axis, parseInt(e.target.value));
    group.appendChild(input);

    coords.appendChild(group);
  });

  div.appendChild(coords);

  // Actions
  const actions = document.createElement('div');
  actions.className = 'record-actions';

  const dupBtn = document.createElement('button');
  dupBtn.className = 'record-btn';
  dupBtn.textContent = 'üìã Dup';
  dupBtn.onclick = () => duplicateRecord(spawnIdx, recIdx);
  actions.appendChild(dupBtn);

  const delBtn = document.createElement('button');
  delBtn.className = 'danger record-btn';
  delBtn.textContent = 'üóëÔ∏è';
  delBtn.onclick = () => deleteRecord(spawnIdx, recIdx);
  actions.appendChild(delBtn);

  div.appendChild(actions);

  return div;
}

function updateRecordMonster(spawnIdx, recIdx, newSlot) {
  const spawn = currentData.zone_spawns[spawnIdx];
  const record = spawn.records[recIdx];
  record.slot = newSlot;

  // Update composition
  recalculateComposition(spawnIdx);
  renderEditor();
  showStatus('Monster updated', 'ok');
}

function updateRecordCoord(spawnIdx, recIdx, axis, value) {
  const record = currentData.zone_spawns[spawnIdx].records[recIdx];
  record[axis] = value;
  showStatus(`Coordinate ${axis.toUpperCase()} updated`, 'ok');
}

function duplicateRecord(spawnIdx, recIdx) {
  const spawn = currentData.zone_spawns[spawnIdx];
  const original = spawn.records[recIdx];

  // Create duplicate with small offset
  const duplicate = JSON.parse(JSON.stringify(original));
  duplicate.x += Math.floor(Math.random() * 200) - 100;
  duplicate.z += Math.floor(Math.random() * 200) - 100;

  spawn.records.splice(recIdx + 1, 0, duplicate);
  spawn.total = spawn.records.length;

  recalculateComposition(spawnIdx);
  renderEditor();
  showStatus('Record duplicated', 'ok');
}

function deleteRecord(spawnIdx, recIdx) {
  if (!confirm('Delete this enemy spawn?')) return;

  const spawn = currentData.zone_spawns[spawnIdx];
  spawn.records.splice(recIdx, 1);
  spawn.total = spawn.records.length;

  recalculateComposition(spawnIdx);
  renderEditor();
  showStatus('Record deleted', 'ok');
}

function addRecordToGroup(spawnIdx) {
  const spawn = currentData.zone_spawns[spawnIdx];

  // Get a sample position from existing records
  let baseX = 0, baseY = 0, baseZ = 0;
  if (spawn.records.length > 0) {
    const last = spawn.records[spawn.records.length - 1];
    baseX = last.x;
    baseY = last.y;
    baseZ = last.z;
  }

  // Create new record
  const newRecord = {
    slot: spawn.records[0]?.slot || 0,
    x: baseX + Math.floor(Math.random() * 200) - 100,
    y: baseY,
    z: baseZ + Math.floor(Math.random() * 200) - 100,
    byte0: 0,
    byte10_11: '0000',
    area_id: spawn.records[0]?.area_id || '0000',
    offset: spawn.records[0]?.offset || '0x0'
  };

  spawn.records.push(newRecord);
  spawn.total = spawn.records.length;

  recalculateComposition(spawnIdx);
  renderEditor();
  showStatus('Enemy added to group', 'ok');
}

function deleteSpawnGroup(idx) {
  if (!confirm(`Delete spawn group ${idx + 1}?`)) return;

  currentData.zone_spawns.splice(idx, 1);
  currentData.zone_spawn_count = currentData.zone_spawns.length;

  renderEditor();
  showStatus('Spawn group deleted', 'ok');
}

function addNewSpawnGroup() {
  if (!currentData) {
    showStatus('Please load a file first', 'err');
    return;
  }

  const newSpawn = {
    total: 1,
    composition: [{
      count: 1,
      slot: 0,
      monster: currentData.monsters[0] || 'Unknown'
    }],
    records: [{
      slot: 0,
      x: 0,
      y: 0,
      z: 0,
      byte0: 0,
      byte10_11: '0000',
      area_id: '0000',
      offset: '0x0'
    }],
    suffix: '00000000',
    offset: '0x0'
  };

  currentData.zone_spawns.push(newSpawn);
  currentData.zone_spawn_count = currentData.zone_spawns.length;

  renderEditor();
  showStatus('New spawn group added', 'ok');
}

function recalculateComposition(spawnIdx) {
  const spawn = currentData.zone_spawns[spawnIdx];
  const slotCounts = {};

  spawn.records.forEach(rec => {
    slotCounts[rec.slot] = (slotCounts[rec.slot] || 0) + 1;
  });

  spawn.composition = Object.keys(slotCounts).map(slot => ({
    count: slotCounts[slot],
    slot: parseInt(slot),
    monster: currentData.monsters[parseInt(slot)] || `Slot${slot}`
  }));

  spawn.total = spawn.records.length;
}

function sortBySize() {
  if (!currentData || !currentData.zone_spawns) return;

  currentData.zone_spawns.sort((a, b) => (b.total || 0) - (a.total || 0));
  renderEditor();
  showStatus('Sorted by size', 'ok');
}

function compactAllGroups() {
  if (!currentData || !currentData.zone_spawns) return;

  // Remove empty groups
  currentData.zone_spawns = currentData.zone_spawns.filter(sg => sg.records && sg.records.length > 0);
  currentData.zone_spawn_count = currentData.zone_spawns.length;

  renderEditor();
  showStatus('Compacted (removed empty groups)', 'ok');
}

function saveFile() {
  if (!currentData) {
    showStatus('No file loaded', 'err');
    return;
  }

  const json = JSON.stringify(currentData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = currentFile || 'zone_spawns.json';
  a.click();

  URL.revokeObjectURL(url);
  showStatus('File saved: ' + a.download, 'ok');
}

function showStatus(msg, type) {
  const status = document.getElementById('status');
  status.textContent = msg;
  status.className = type;
  setTimeout(() => {
    status.style.display = 'none';
  }, 3000);
}
</script>

</body>
</html>
